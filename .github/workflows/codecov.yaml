name: Unit and Coverage test

on: [push, pull_request, workflow_dispatch]

permissions:
  contents: read

defaults:
  run:
    shell: 'script -q -e -c "bash {0}"'

jobs:
  build:

    permissions:
      contents: write  # for stefanzweifel/git-auto-commit-action to push code in repo

    runs-on: ubuntu-latest
    steps:

      - name: Harden Runner
        uses: step-security/harden-runner@55d479fb1c5bcad5a4f9099a5d9f37c8857b2845 # v2.4.1
        with:
          egress-policy: audit

      - name: Checkout with all submodules
        uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3
        with:
          fetch-depth: 3
          submodules: recursive

      - name: Get Ruby v3 with bundler cache
        uses: ruby/setup-ruby@250fcd6a742febb1123a77a841497ccaa8b9e939 # v1.152.0
        with:
          ruby-version: '3.2.1' # Not needed with a .ruby-version file
          bundler-cache: true
          cache-version: 1

      - name: Instal gems
        run: gem install bashcov simplecov codecov simplecov-cobertura simplecov-csv simplecov_json_formatter simplecov-tailwindcss

      - name: Run unit test script
        run: |
          chmod +x cloudflare-dns.sh
          bashcov unit-test.sh
        shell: bash

      - name: Upload reports to Codecov
        uses: codecov/codecov-action@eaaf4bedf32dbdc6b720b63067d99c4d77d6047d # v3.1.4

      - name: Run codacy-coverage-reporter
        uses: codacy/codacy-coverage-reporter-action@89d6c85cfafaec52c72b6c5e8b2878d33104c699 # v1.3.0
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: coverage/coverage.xml

      - name: Clean files
        run: |
          rm -rf vendor
          rm -rf Gemfile.lock
        shell: bash

      - name: Commit all changed files back to the repository
        uses: stefanzweifel/git-auto-commit-action@3ea6ae190baf489ba007f7c92608f33ce20ef04a # v4.16.0
        with:
          commit_message: Push coverage report
          file_pattern: 'coverage/**'
          commit_user_name: jmrplens
          commit_user_email: jmrplens@gmail.com
          commit_author: Jos√© M. Requena Plens <jmrplens@gmail.com>

