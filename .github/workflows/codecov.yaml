name: Unit Test on Linux and MacOS

on: [push, pull_request, workflow_dispatch]

permissions:
  contents: write

jobs:
  run_test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest,ubuntu-latest]
        ruby: ['3.0', '3.1', '3.2']
    env:
      OS: ${{ matrix.os }}
      BASH: '5.1'
      RUBY: ${{ matrix.ruby }}
      BUNDLE_GEMFILE: test/Gemfile

    steps:

      - name: Checkout with all submodules
        uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3
        with:
          fetch-depth: 3
          submodules: recursive

      - name: Get Ruby and install gems
        uses: ruby/setup-ruby@250fcd6a742febb1123a77a841497ccaa8b9e939 # v1.152.0
        with:
          ruby-version: ${{ matrix.ruby }}
      - run: bundle install
      
      - name: Run unit test script
        run: |
          chmod +x cloudflare-dns.sh
          chmod +x unit-test.sh
          bashcov ./unit-test.sh
        shell: bash

      - name: Upload reports to Codecov
        uses: codecov/codecov-action@eaaf4bedf32dbdc6b720b63067d99c4d77d6047d # v3.1.4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage.xml
          flags: UnitTest_OS_${{ matrix.os }}_RUBY_${{ matrix.ruby }}
          full_report: ./coverage/
          env_vars: OS,BASH,RUBY
          functionalities: gcov
          os: linux
          directory: ./coverage/
          name: "DynDNS Cloudflare - OS: ${{ matrix.os } ; RUBY: ${{ matrix.ruby }}"
          verbose: true

      - name: Run codacy-coverage-reporter
        uses: codacy/codacy-coverage-reporter-action@89d6c85cfafaec52c72b6c5e8b2878d33104c699 # v1.3.0
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: coverage/coverage.xml
      
      #- name: Clean files
       # run: |
        #  rm -rf vendor
        #  rm -rf Gemfile.lock
        #shell: bash
      - run: mkdir coverage/${{ matrix.os }}_Ruby_${{ matrix.ruby }}/
      - name: Commit all changed files back to the repository
        uses: stefanzweifel/git-auto-commit-action@3ea6ae190baf489ba007f7c92608f33ce20ef04a # v4.16.0
        with:
          commit_message: Push coverage report
          file_pattern: 'coverage/${{ matrix.os }}_Ruby_${{ matrix.ruby }}/**'
          commit_user_name: jmrplens
          commit_user_email: jmrplens@gmail.com
          commit_author: Jos√© M. Requena Plens <jmrplens@gmail.com>

